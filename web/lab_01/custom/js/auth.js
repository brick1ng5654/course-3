// üîê –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –û–ë–™–Ø–í–õ–Ø–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–û
window.showAuthModal = function() {
    console.log('üîÑ showAuthModal –≤—ã–∑–≤–∞–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const modalElement = document.getElementById('authModal');
    const authButton = document.getElementById('authButton');
    
    console.log('modalElement:', !!modalElement);
    console.log('authButton:', !!authButton);
    
    if (!modalElement) {
        console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        alert('–û—à–∏–±–∫–∞: Bootstrap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    
    try {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞: ' + error.message);
    }
};

window.performAuth = function() {
    console.log('üîÑ performAuth –≤—ã–∑–≤–∞–Ω–∞');
    const login = document.getElementById('authLogin').value;
    const password = document.getElementById('authPassword').value;
    
    console.log('–í–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', { login, password });
    
    if (!login || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    const validUsers = {
        'admin': 'password123',
        'user': 'user123', 
        'test': 'test123'
    };
    
    if (validUsers[login] && validUsers[login] === password) {
        console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', login);
        window.authCredentials = btoa(login + ':' + password);
        window.isAuthenticated = true;
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
            submitBtn.textContent = '–ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é';
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
        if (modal) {
            modal.hide();
        }
        
        alert('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É.');
    } else {
        console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    }
};

// üîê –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏');
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const authButton = document.getElementById('authButton');
    if (authButton) {
        authButton.addEventListener('click', showAuthModal);
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    } else {
        console.error('‚ùå –ö–Ω–æ–ø–∫–∞ authButton –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    }
    
    const authForm = document.getElementById('authForm');
    if (!authForm) {
        console.error('‚ùå –§–æ—Ä–º–∞ authForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        return;
    }
    
    authForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('üîÑ –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, isAuthenticated:', window.isAuthenticated);
        
        if (!window.isAuthenticated) {
            alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
            showAuthModal();
            return;
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /process');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        fetch('https://localhost/process?' + params.toString(), {
            method: 'GET',
            headers: {
                'Authorization': 'Basic ' + window.authCredentials
            }
        })
        .then(response => {
            console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);
            if (response.status === 401) {
                alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                window.isAuthenticated = false;
                document.getElementById('submitBtn').disabled = true;
                showAuthModal();
                return;
            }
            return response.text();
        })
        .then(html => {
            console.log('‚úÖ HTML –ø–æ–ª—É—á–µ–Ω, –æ—Ç–∫—Ä—ã–≤–∞—é –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ');
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const newWindow = window.open();
            newWindow.document.write(html);
            newWindow.document.close();
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
        });
    });
    
    console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
});